<!DOCTYPE HTML>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>刀剣乱舞 機動計算</title>
<!--link rel="stylesheet" href="touken__common.css" type="text/css"-->
<style type="text/css">
body{
	font-size:13px;
	margin:0;
	padding:2px 2px;
}

[type="number"],
select{
	font-family:"MS UI Gothic", sans-serif;
	font-size:13px;
}

td[id^="res"]{
	-moz-user-select:all;
}

[type="number"]{
	text-align:right;
	width:42px;
}

[id^="level"]{
	width:36px;
}

fieldset{
	border: none;
	padding:0.4em 0 0 0;
	border-top:2px solid #dfdfdf;
	margin-top:1em;
}
legend{
	margin-left:0.75em;
}

table{
	margin: 0.4em 0 0 0;
}
th,td{
	text-align:left;
	line-height:1.2 !important;
}
th+th,td+td{
	padding-left:2px;
}
tr:nth-child(n+3) td{
	padding-top:4px;
}
div{
	white-space:nowrap;
}
div+div{
	margin-top:0.3em;
}

#option_all{
	padding:0;
	margin:0 0 1em;
	list-style:none;
}





@media (min-width:500px){
	form{
		max-width:400px;
	}
}

</style>
</head>
<body>

<form id="calculator">

<ul id="option_all">
	<li><label><input type="checkbox" id="float" onchange="update_all('float')">小数で表示</label></li>
	<li><label><input type="checkbox" id="growth" onchange="update_all('growth')">7-1以降</label></li>
</ul>


<fieldset>
<legend>部隊1</legend>

<select id="formation0" onchange="update_unit(0)">
	<option value="12">逆行</option>
	<option value="11">雁行</option>
	<option value="10" selected="selected">魚/横</option>
	<option value="9">鶴/方</option>
</select>

<table>
<tr>
	<th>Lv</th>
	<th>Mo</th>
	<th>Co</th>
	<th></th>
</tr>
<tr>
	<td><input type="number" value="0" id="level0" min="0" max="99" onchange="update('level',0);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile0" min="0" max="999" onchange="update('mobile',0);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor0" onchange="update('vigor',0);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res0">-</td>
</tr>
<tr>
	<td><input type="number" value="0" id="level1" min="0" max="99" onchange="update('level',1);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile1" min="0" max="999" onchange="update('mobile',1);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor1" onchange="update('vigor',1);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res1">-</td>
</tr>
<tr>
	<td><input type="number" value="0" id="level2" min="0" max="99" onchange="update('level',2);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile2" min="0" max="999" onchange="update('mobile',2);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor2" onchange="update('vigor',2);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res2">-</td>
</tr>
<tr>
	<td><input type="number" value="0" id="level3" min="0" max="99" onchange="update('level',3);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile3" min="0" max="999" onchange="update('mobile',3);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor3" onchange="update('vigor',3);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res3">-</td>
</tr>
<tr>
	<td><input type="number" value="0" id="level4" min="0" max="99" onchange="update('level',4);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile4" min="0" max="999" onchange="update('mobile',4);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor4" onchange="update('vigor',4);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res4">-</td>
</tr>
<tr>
	<td><input type="number" value="0" id="level5" min="0" max="99" onchange="update('level',5);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile5" min="0" max="999" onchange="update('mobile',5);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor5" onchange="update('vigor',5);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res5">-</td>
</tr>
</table>
</fieldset>

<fieldset>
<legend>部隊2</legend>

<select id="formation1" onchange="update_unit(1)">
	<option value="12">逆行</option>
	<option value="11">雁行</option>
	<option value="10" selected="selected">魚/横</option>
	<option value="9">鶴/方</option>
</select>

<table>
<tr>
	<th>Lv</th>
	<th>Mo</th>
	<th>Co</th>
	<th></th>
</tr>
<tr>
	<td><input type="number" value="0" id="level6" min="0" max="99" onchange="update('level',6);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile6" min="0" max="999" onchange="update('mobile',6);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor6" onchange="update('vigor',6);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res6">-</td>
</tr>
<tr>
	<td><input type="number" value="0" id="level7" min="0" max="99" onchange="update('level',7);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile7" min="0" max="999" onchange="update('mobile',7);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor7" onchange="update('vigor',7);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res7">-</td>
</tr>
<tr>
	<td><input type="number" value="0" id="level8" min="0" max="99" onchange="update('level',8);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile8" min="0" max="999" onchange="update('mobile',8);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor8" onchange="update('vigor',8);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res8">-</td>
</tr>
<tr>
	<td><input type="number" value="0" id="level9" min="0" max="99" onchange="update('level',9);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile9" min="0" max="999" onchange="update('mobile',9);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor9" onchange="update('vigor',9);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res9">-</td>
</tr>
<tr>
	<td><input type="number" value="0" id="level10" min="0" max="99" onchange="update('level',10);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile10" min="0" max="999" onchange="update('mobile',10);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor10" onchange="update('vigor',10);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res10">-</td>
</tr>
<tr>
	<td><input type="number" value="0" id="level11" min="0" max="99" onchange="update('level',11);" onclick="this.select(0,this.value.length)"></td>
	<td><input type="number" value="0" id="mobile11" min="0" max="999" onchange="update('mobile',11);" onclick="this.select(0,this.value.length)"></td>
	<td>
		<select id="vigor11" onchange="update('vigor',11);">
			<option value="12">1.2</option>
			<option value="10" selected="selected">1.0</option>
			<option value="8">0.8</option>
			<option value="6">0.6</option>
			<option value="7">0.7</option>
			<option value="5">0.5</option>
		</select>
	</td>
	<td id="res11">-</td>
</tr>
</table>
</fieldset>
</form>

<script>
// 入力データ
var $cache = {
	float:0,
	growth:0,
	formation:[],
	lines:[],
	last_result:["-","-","-","-","-","-","-","-","-","-","-","-"]
};

// 初期値
window.onload = function(){
	var $f = document.getElementById("calculator").elements;
	var $data = $cache;
	var $lines = $data.lines;
	var reCalc = false;
	var t = {};
	var i = 0;
	for(i; i<12; i++){
		t.level = $f["level"+i].value;
		t.mobile = $f["mobile"+i].value;
		if(!reCalc && !!(t.level*t.mobile)){ reCalc=true; }
		$lines[i]={
			level:t.level,
			mobile:t.mobile,
			vigor:$f["vigor"+i].value
		};
	}

	$data.formation[0] = $f.formation0.value;
	$data.formation[1] = $f.formation1.value;
	$data.float = +$f.float.checked;
	$data.growth = +$f.growth.checked;

	if(reCalc){
		update_all();
	}
//	console.log($cache);
};

// 文字列を数値化
function getNumber(str){
	return (/^\d{1,3}$/.test(str))? str*1 : 0;
}

// $cache更新
function setGlobal(trigger,value){
	if(value==null){
		const name = trigger.name;
		const index = trigger.index;
		const id = name + index;
		value = document.getElementById(id).value;
		if(name!=="formation"){
			$cache.lines[index][name] = getNumber(value);
		}else{
			$cache[name][index] = getNumber(value);
		}
	}else{
		$cache[trigger] = ($cache[trigger]===value)? +!value : value;
	}
}

// 計算
function doCalc(i,ix,$result){
	let $data = $cache;
	let $lines = $data.lines;
	const unit_no = (i<6)? 0 : 1;
	const acceleration = $data.formation[unit_no];
	const growth = [4,2][$data.growth];
	const float = $data.float;
	let level, mobile, result;
	for(i; i<ix; i++){
		level = $lines[i].level;
		mobile = $lines[i].mobile;
		if(level*mobile<1){ $result[i] = "-"; continue; }//error
		result = (mobile*(level*growth+100)*acceleration*$lines[i].vigor)/10000;
		$result[i] = (!float)? ~~result : result;
	}
}

// 出力
function printResult(i,ix,$result){
	let $last = $cache.last_result;
	let id, result;
	for(i; i<ix; i++){
		result = $result[i];
		if($last[i]!==result){
			$last[i] = result;
			id = "res"+i;
			document.getElementById(id).textContent = result;
		}
	}
}

// 1行
function update(trigger,line){
	setGlobal({name:trigger,index:line});
	const ix = line+1;

	var $result = [0,0,0,0,0,0,0,0,0,0,0,0];
	doCalc(line,ix,$result);
	printResult(line,ix,$result);
}

// 全体
function update_all(trigger,value){
	if(trigger!=null){
		if(value==null){
			setGlobal(trigger,$cache[trigger]);
		}else{
			setGlobal(trigger,value);
		}
	}
	var $result = [0,0,0,0,0,0,0,0,0,0,0,0];
	doCalc(0,6,$result);
	doCalc(6,12,$result);
	printResult(0,12,$result);
}

// 陣形変更
function update_unit(unit_no){
	setGlobal({name:"formation",index:unit_no});
	const i = (!unit_no)? 0 : 6;
	const ix = i+6;

	var $result = [0,0,0,0,0,0,0,0,0,0,0,0];
	doCalc(i,ix,$result);
	printResult(i,ix,$result);
}

</script>
</body>
</html>
